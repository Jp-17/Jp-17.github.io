---
layout: default
---

<article>
  <header class="post-header">
    <h1 class="post-title post-title-cn">{{ page.title_cn | default: page.title }}</h1>
    <h1 class="post-title post-title-en">{{ page.title_en | default: page.title }}</h1>
    <div class="post-meta">
      <span class="post-date-display">{{ page.date | date: "%Y-%m-%d" }}</span>
      {% if page.bilingual %}
      <div class="lang-toggle" role="group" aria-label="Language selector">
        <button class="lang-btn" data-lang="cn" onclick="setLang('cn')">CN</button>
        <button class="lang-btn" data-lang="en" onclick="setLang('en')">EN</button>
      </div>
      {% endif %}
    </div>
  </header>

  <div class="post-toc" id="post-toc" aria-label="Table of contents"></div>

  <div class="post-body">
    {{ content }}
  </div>
</article>

<script>
(function () {
  function getCurrentLang() {
    if (document.querySelector('.lang-cn.active')) return 'cn';
    if (document.querySelector('.lang-en.active')) return 'en';
    return null;
  }

  function getHeadingContainer() {
    var lang = getCurrentLang();
    if (lang) return document.querySelector('.lang-' + lang + '.active');
    return document.querySelector('.post-body');
  }

  function ensureId(el, idx) {
    if (!el.id) {
      var base = el.textContent.trim()
        .replace(/\s+/g, '-')
        .replace(/[^\w\u4e00-\u9fff-]/g, '')
        .substring(0, 40);
      el.id = base || ('toc-' + idx);
    }
    return el.id;
  }

  function buildTOC() {
    var toc = document.getElementById('post-toc');
    if (!toc) return;
    var container = getHeadingContainer();
    if (!container) return;

    var headings = Array.prototype.slice.call(container.querySelectorAll('h2, h3'));
    if (headings.length < 2) { toc.style.display = 'none'; return; }

    toc.style.display = '';
    headings.forEach(function (h, i) { ensureId(h, i); });

    var label = getCurrentLang() === 'en' ? 'Contents' : '目录';
    var html = '<span class="post-toc-label">' + label + '</span><ul class="post-toc-list">';
    headings.forEach(function (h) {
      var cls = h.tagName === 'H3' ? ' toc-h3' : '';
      html += '<li class="toc-item' + cls + '"><a href="#' + h.id + '">'
            + h.textContent.trim() + '</a></li>';
    });
    html += '</ul>';
    toc.innerHTML = html;
  }

  window.rebuildTOC = buildTOC;

  // Non-bilingual posts: build on load (bilingual posts: lang-toggle.js will call rebuildTOC)
  if (!document.querySelector('.lang-cn, .lang-en')) {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', buildTOC);
    } else {
      buildTOC();
    }
  }
})();
</script>

{% if page.bilingual %}
<script src="{{ '/assets/js/lang-toggle.js' | relative_url }}"></script>
{% endif %}

{% if page.math %}
<script>
  MathJax = {
    tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
    svg: { fontCache: 'global' }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
{% endif %}
